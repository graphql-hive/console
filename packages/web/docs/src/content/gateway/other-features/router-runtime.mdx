import { Callout, Tabs } from '@theguild/components'

# Router Runtime

<Callout type="warning" emoji="üöß">

This feature is EXPERIMENTAL and is subject to extensive change in future releases. Some features
might not work as expected or at all, and the API might change at any time. Please use with caution!

</Callout>

## Introduction

Hive Gateway can now use parts of [Hive Router's](/docs/router) runtime, like the Query Planner,
introducing a new federation query planner in JavaScript that aims to optimize query execution
performance by using Rust Hive Router's advanced planning algorithms through native addons.

This integration allows Hive Gateway to leverage the high-performance capabilities of Hive Router's
runtime while still operating within the Node.js or Bun environment and offering the full suite of
JavaScript's ecosystem back to Hive Router.

## Getting Started

Start by installing the necessary package:

```sh npm2yarn
npm install @graphql-hive/router-runtime
```

Then, configure your Hive Gateway to use the Hive Router Runtime by updating your gateway's
configuration:

<Tabs items={['CLI', "Programmatic Usage"]}>

<Tabs.Tab>

```ts filename="gateway.config.ts"
import { defineConfig } from '@graphql-hive/gateway'
import { unifiedGraphHandler } from '@graphql-hive/router-runtime'

export const gatewayConfig = defineConfig({
  unifiedGraphHandler
})
```

</Tabs.Tab>

<Tabs.Tab>

```ts filename="index.ts"
import { createGatewayRuntime } from '@graphql-hive/gateway-runtime'
import { unifiedGraphHandler } from '@graphql-hive/router-runtime'

export const gateway = createGatewayRuntime({
  unifiedGraphHandler
})
```

</Tabs.Tab>

</Tabs>

## Compared to Stitching Runtime

<Callout type="info" emoji="‚ÑπÔ∏è">

While Router Runtime provides superior performance for many workloads, it sacrifices some of the
flexibility and extensibility of the Stitching Runtime.

</Callout>

By default, Hive Gateway uses the Stitching Runtime, which is a pure JavaScript implementation
designed for flexibility and ease of use. The Stitching Runtime is well-suited for most
applications, providing a robust and adaptable solution for GraphQL federation.

The following table provides a comprehensive comparison between the two runtimes:

| Feature                      | Stitching | Router                | Notes                                                                                            |
| ---------------------------- | --------- | --------------------- | ------------------------------------------------------------------------------------------------ |
| Additional resolvers         | ‚úÖ        | ‚ùå                    | Additional type resolvers not supported                                                          |
| Schema transforms            | ‚úÖ        | ‚ùå                    | Schema transformation pipeline not available in router runtime                                   |
| Schema extensions            | ‚úÖ        | ‚ö†Ô∏è Limited support    | Schema-level modifications may be limited because hive router does not use an executable schema  |
| Custom plugins               | ‚úÖ        | ‚ö†Ô∏è No stitching hooks | All plugins, except those using [stitching hooks](#no-stitching-runtime-plugin-hooks), will work |
| Envelop plugins              | ‚úÖ        | ‚úÖ                    | All of envelop plugins will work                                                                 |
| Yoga plugins                 | ‚úÖ        | ‚úÖ                    | All of Yoga plugins will work                                                                    |
| Gateway plugins              | ‚úÖ        | ‚úÖ                    | All gateway plugins will work                                                                    |
| Transports                   | ‚úÖ        | ‚úÖ                    | All transports that Hive Gateway supports work. HTTP, WS, SSE, gRPC, etc.                        |
| Federation Query Planning    | ‚úÖ        | ‚úÖ                    | Router runtime uses advanced Rust query planner for better performance                           |
| Response caching             | ‚úÖ        | ‚úÖ                    | In-memory and distributed caching (Redis, etc.)                                                  |
| Request batching             | ‚úÖ        | ‚úÖ                    | Automatic batching of requests to subgraphs                                                      |
| Parsing & validation caching | ‚úÖ        | ‚úÖ                    | Document parsing and validation optimization                                                     |
| Query cost analysis          | ‚úÖ        | ‚úÖ                    | Query complexity and cost analysis                                                               |
| Prometheus metrics           | ‚úÖ        | ‚úÖ                    | Standard metrics collection and export                                                           |
| OpenTelemetry tracing        | ‚úÖ        | ‚úÖ                    | Distributed tracing and span creation                                                            |
| Custom spans                 | ‚úÖ        | ‚úÖ                    | Custom instrumentation can be added                                                              |
| Request logging              | ‚úÖ        | ‚úÖ                    | Request/response logging and auditing                                                            |
| JWT authentication           | ‚úÖ        | ‚úÖ                    | JSON Web Token validation and propagation                                                        |
| Rate limiting                | ‚úÖ        | ‚úÖ                    | Field-level and global rate limiting                                                             |
| Depth limiting               | ‚úÖ        | ‚úÖ                    | Query depth and complexity analysis                                                              |
| Max tokens                   | ‚úÖ        | ‚úÖ                    | Token-based request limiting                                                                     |
| HMAC signing                 | ‚úÖ        | ‚úÖ                    | Inter-service request signing and verification                                                   |
| Persisted documents          | ‚úÖ        | ‚úÖ                    | Operation allow-listing and security                                                             |
| Request plugins              | ‚úÖ        | ‚úÖ                    | Request-level processing and modification                                                        |
| Response plugins             | ‚úÖ        | ‚úÖ                    | Response-level processing and modification                                                       |

## No Stitching Runtime Plugin Hooks

All plugin hooks will work with Router Runtime except for those specific to stitching that will
never work because the runtime is different (router runtime vs stitching runtime). Those hooks are:

- [`onDelegationPlan`](/docs/gateway/other-features/custom-plugins#ondelegationplan)
- [`onDelegationStageExecute`](/docs/gateway/other-features/custom-plugins#ondelegationstageexecute)

## Federation Specification Compliance

Hive Gateway with Router Runtime maintains 100% compatibility in the
[Federation-Compatibility Audit](https://the-guild.dev/graphql/hive/federation-gateway-audit). This
ensures that your federated GraphQL architecture remains standards-compliant and interoperable
across different Federation implementations.
